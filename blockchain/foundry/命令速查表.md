# Foundry 命令速查表

## Forge 命令

### 项目管理
```bash
forge init <project>              # 创建新项目
forge install <dependency>        # 安装依赖
forge update                      # 更新依赖
forge remove <dependency>         # 删除依赖
forge clean                       # 清理构建缓存
```

### 编译
```bash
forge build                       # 编译项目
forge build --force               # 强制重新编译
forge build --sizes               # 显示合约大小
```

### 测试
```bash
forge test                        # 运行所有测试
forge test -vv                    # 详细输出
forge test -vvvv                  # 最详细输出
forge test --match-test <name>   # 运行特定测试
forge test --match-contract <name> # 运行特定合约测试
forge test --gas-report           # Gas 报告
forge test --debug <test>         # 调试模式
forge test --fork-url <url>       # Fork 测试
```

### 部署
```bash
forge create <contract>           # 部署合约
  --rpc-url <url>                 # RPC 端点
  --private-key <key>             # 私钥
  --verify                        # 自动验证
  --etherscan-api-key <key>       # Etherscan API

forge script <script>             # 运行脚本
  --broadcast                     # 广播交易
  --verify                        # 验证合约
```

### 验证
```bash
forge verify-contract             # 验证合约
  <address>                       # 合约地址
  <contract>                      # 合约路径
  --chain-id <id>                 # 链 ID
  --etherscan-api-key <key>       # API 密钥
```

### 其他
```bash
forge fmt                         # 格式化代码
forge snapshot                    # Gas 快照
forge coverage                    # 覆盖率测试
forge doc                         # 生成文档
```

---

## Cast 命令

### 查询
```bash
cast balance <address>            # 查询余额
cast block <number>               # 查询区块
cast tx <hash>                    # 查询交易
cast receipt <hash>               # 查询交易收据
cast code <address>               # 查询合约代码
cast storage <address> <slot>    # 查询存储
```

### 调用
```bash
cast call <address> <sig>         # 只读调用
cast send <address> <sig>         # 发送交易
  --value <amount>                # 发送 ETH
  --private-key <key>             # 私钥
```

### 编码/解码
```bash
cast abi-encode <sig> <args>      # ABI 编码
cast abi-decode <sig> <data>      # ABI 解码
cast calldata <sig> <args>        # 生成 calldata
cast 4byte <sig>                  # 函数选择器
cast keccak <data>                # Keccak-256 哈希
```

### 转换
```bash
cast --to-wei <amount> <unit>     # 转为 Wei
cast --from-wei <amount> <unit>   # 从 Wei 转换
cast --to-hex <number>            # 转为十六进制
cast --to-dec <hex>               # 转为十进制
cast --to-checksum-address <addr> # 校验和地址
```

### 实用工具
```bash
cast wallet new                   # 创建新钱包
cast wallet address --private-key <key> # 从私钥获取地址
cast sig <signature>              # 获取函数签名
```

---

## Anvil 命令

### 启动节点
```bash
anvil                             # 启动本地节点
anvil --port <port>               # 指定端口
anvil --accounts <n>              # 账户数量
anvil --balance <amount>          # 初始余额
anvil --fork-url <url>            # Fork 主网
anvil --fork-block-number <n>    # Fork 特定区块
anvil --chain-id <id>             # 链 ID
anvil --block-time <seconds>      # 出块时间
```

---

## Chisel 命令

```bash
chisel                            # 启动 Solidity REPL
!help                             # 帮助
!quit                             # 退出
!source                           # 查看源码
!clear                            # 清除
```

---

## Cheatcodes 速查

### 账户操作
```solidity
vm.prank(address)                 // 下一次调用设置 msg.sender
vm.startPrank(address)            // 开始持续设置
vm.stopPrank()                    // 停止
vm.deal(address, amount)          // 设置 ETH 余额
```

### 区块操作
```solidity
vm.warp(timestamp)                // 设置时间戳
vm.roll(blockNumber)              // 设置区块号
vm.fee(baseFee)                   // 设置 base fee
vm.difficulty(difficulty)         // 设置难度
vm.prevrandao(value)              // 设置 prevrandao
vm.chainId(id)                    // 设置链 ID
```

### 断言
```solidity
assertEq(a, b)                    // 相等
assertTrue(condition)             // 为真
assertFalse(condition)            // 为假
assertGt(a, b)                    // a > b
assertGe(a, b)                    // a >= b
assertLt(a, b)                    // a < b
assertLe(a, b)                    // a <= b
```

### 预期行为
```solidity
vm.expectRevert()                 // 预期回滚
vm.expectRevert(bytes4)           // 预期特定错误
vm.expectEmit(t1,t2,t3,data)     // 预期事件
emit MyEvent(args)                // 紧跟事件
```

### 存储操作
```solidity
vm.store(address, slot, value)    // 写入存储
vm.load(address, slot)            // 读取存储
```

### 快照
```solidity
uint256 id = vm.snapshot()        // 创建快照
vm.revertTo(id)                   // 恢复快照
```

### 标签
```solidity
vm.label(address, "name")         // 给地址添加标签
```

---

## 环境变量

```bash
# RPC URLs
export MAINNET_RPC_URL="..."
export SEPOLIA_RPC_URL="..."

# API Keys
export ETHERSCAN_API_KEY="..."

# 私钥
export PRIVATE_KEY="0x..."

# 使用
forge script --rpc-url $SEPOLIA_RPC_URL
```

---

## 配置文件 (foundry.toml)

```toml
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
solc_version = "0.8.19"
optimizer = true
optimizer_runs = 200
via_ir = false

[profile.default.fuzz]
runs = 256
max_test_rejects = 65536

[rpc_endpoints]
mainnet = "${MAINNET_RPC_URL}"
sepolia = "${SEPOLIA_RPC_URL}"

[etherscan]
mainnet = { key = "${ETHERSCAN_API_KEY}" }
```

---

## 常用测试模式

### 基础测试
```solidity
function test_Function() public {
    // 测试逻辑
}
```

### 失败测试
```solidity
function testFail_Condition() public {
    // 应该失败的测试
}
```

### 模糊测试
```solidity
function testFuzz_Amount(uint256 amount) public {
    vm.assume(amount > 0);
    // 测试逻辑
}
```

### 不变量测试
```solidity
function invariant_TotalSupply() public {
    assertEq(token.totalSupply(), INITIAL_SUPPLY);
}
```

---

## 部署脚本模板

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.13;

import {Script} from "forge-std/Script.sol";
import {MyContract} from "../src/MyContract.sol";

contract DeployScript is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        
        vm.startBroadcast(deployerPrivateKey);
        
        MyContract myContract = new MyContract();
        
        vm.stopBroadcast();
    }
}
```

运行：
```bash
forge script script/Deploy.s.sol --rpc-url sepolia --broadcast --verify
```

---

## Gas 优化技巧

1. **使用快照比较**
```bash
forge snapshot
# 修改代码
forge snapshot --diff
```

2. **查看详细 Gas 报告**
```bash
forge test --gas-report
```

3. **使用 `unchecked` 块**
```solidity
unchecked {
    counter++;  // 节省 Gas
}
```

4. **使用 `calldata` 而非 `memory`**
```solidity
function process(uint[] calldata data) external {
    // 更省 Gas
}
```

---

## 调试技巧

1. **使用详细输出**
```bash
forge test -vvvv
```

2. **使用 console.log**
```solidity
import {console} from "forge-std/console.sol";

console.log("Value:", value);
console.log("Address:", addr);
```

3. **使用调试器**
```bash
forge test --debug testFunction
```

4. **使用 trace**
```bash
forge test --gas-report -vvvv
```

---

**快速参考，提升开发效率！** ⚡
